<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Dr. Shir Sivroni">
  <meta name="description" content="PrimingToolbox - A universal platform for priming experiments based on the ABCD framework (Sivroni & Stark, 2025)">

  <title>PrimingToolbox - Open University</title>

  <!-- External Libraries -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="css/main.css?v=1.4">
  <link rel="stylesheet" href="css/experiment.css?v=1.1">
</head>
<body>

  <!-- Animated Background -->
  <div class="animated-background">
    <div class="wave-container">
      <svg class="wave wave-teal" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path d="M0,160 C320,220 420,100 720,160 C1020,220 1120,100 1440,160 L1440,320 L0,320 Z"></path>
      </svg>
      <svg class="wave wave-pink" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path d="M0,200 C280,260 380,140 680,200 C980,260 1080,140 1440,200 L1440,320 L0,320 Z"></path>
      </svg>
      <svg class="wave wave-wine" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path d="M0,240 C240,300 340,180 640,240 C940,300 1040,180 1440,240 L1440,320 L0,320 Z"></path>
      </svg>
    </div>
    <div class="particles">
      <div class="particle particle-teal" style="left: 10%; top: 20%;"></div>
      <div class="particle particle-pink" style="left: 30%; top: 60%;"></div>
      <div class="particle particle-wine" style="left: 50%; top: 30%;"></div>
      <div class="particle particle-teal" style="left: 70%; top: 70%;"></div>
      <div class="particle particle-pink" style="left: 90%; top: 40%;"></div>
      <div class="particle particle-wine" style="left: 20%; top: 80%;"></div>
      <div class="particle particle-teal" style="left: 60%; top: 10%;"></div>
      <div class="particle particle-pink" style="left: 80%; top: 50%;"></div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span>PrimingToolbox</span>
        <span class="copyright">v1.0</span>
      </div>

      <h3>Quick Settings</h3>
      <label for="experimentSelect">Experiment Type</label>
      <select id="experimentSelect" onchange="loadExperimentConfig(this.value)">
        <option value="">-- Select --</option>
        <option value="stroop">Stroop Task</option>
        <option value="semantic">Semantic Priming</option>
        <option value="affective">Affective Priming</option>
      </select>

      <div class="sidebar-footer">
        <span class="copyright">© The Open University of Israel</span>
        <span class="copyright">Developed by Shir Sivroni</span>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <h1>PrimingToolbox</h1>
      <p class="subtitle">A universal platform for priming experiments</p>

      <!-- Module Cards -->
      <div class="modules-grid">

        <!-- Try Experiment Card -->
        <div class="module-card" onclick="showTryExperiment()">
          <div class="module-content">
            <div class="module-icon">&#9658;</div>
            <div class="module-title">Try an Experiment</div>
            <div class="module-description">
              Experience a priming experiment yourself. Great for learning and testing.
            </div>
            <ul class="module-options">
              <li>Stroop Task</li>
              <li>Semantic Priming</li>
              <li>Affective Priming</li>
            </ul>
          </div>
        </div>

        <!-- Template Builder Card -->
        <div class="module-card" onclick="showTemplateBuilder()">
          <div class="module-content">
            <div class="module-icon">&#9881;</div>
            <div class="module-title">Template Builder</div>
            <div class="module-description">
              Configure and customize experiments for your research.
            </div>
            <ul class="module-options">
              <li>Custom stimuli</li>
              <li>Timing control</li>
              <li>Generate participant links</li>
            </ul>
          </div>
        </div>

        <!-- Get My Data Card -->
        <div class="module-card" onclick="showGetData()">
          <div class="module-content">
            <div class="module-icon">&#128202;</div>
            <div class="module-title">Get My Data</div>
            <div class="module-description">
              Retrieve and export your experiment data.
            </div>
            <ul class="module-options">
              <li>Download CSV</li>
              <li>Download Excel</li>
              <li>Filter by experiment ID</li>
            </ul>
          </div>
        </div>

        <!-- Learn More Card -->
        <div class="module-card" onclick="showLearnMore()">
          <div class="module-content">
            <div class="module-icon">&#128218;</div>
            <div class="module-title">Learn More</div>
            <div class="module-description">
              Understand the ABCD framework and priming paradigms.
            </div>
            <ul class="module-options">
              <li>ABCD Framework</li>
              <li>Priming types</li>
              <li>Research resources</li>
            </ul>
          </div>
        </div>

      </div>

      <!-- ABCD Framework Info -->
      <div class="card" style="margin-top: 20px;">
        <div class="card-content">
          <h3 class="card-title" style="color: #ff4db8;">The ABCD Framework</h3>
          <p style="color: #9aa6b2; line-height: 1.8;">
            <strong style="color: #ffffff;">A</strong> = Prime (the influencing information)<br>
            <strong style="color: #ffffff;">B</strong> = Target (the input that requires processing)<br>
            <strong style="color: #ffffff;">C</strong> = Baseline outcome (without A)<br>
            <strong style="color: #ffffff;">D</strong> = Measured outcome (with A)
          </p>
          <p style="color: #9aa6b2; margin-top: 15px; font-size: 0.9rem;">
            Three characteristics define priming: <strong>Association</strong> (A-B relationship),
            <strong>Secondariness</strong> (A is task-irrelevant), and
            <strong>Modulation</strong> (A changes outcome from C to D).
          </p>
        </div>
      </div>

    </main>
  </div>

  <!-- Trial Timeline -->
  <div class="timeline-container">
    <div class="timeline-header">
      <span class="timeline-title">Trial Timeline</span>
      <span class="timeline-total">Total duration: <span id="total-duration">1600</span> ms</span>
    </div>
    <div class="timeline-track" id="timeline-track">
      <div class="timeline-axis"></div>
      <div class="timeline-ticks" id="timeline-ticks"></div>

      <!-- Fixation Event -->
      <div class="timeline-event" id="event-fixation" style="left: 0%;">
        <div class="event-box">
          <div class="event-label">Fixation</div>
          <div class="event-content">+</div>
        </div>
        <div class="event-connector"></div>
        <div class="event-dot"></div>
        <div class="event-time">0 ms</div>
      </div>

      <!-- Prime Event -->
      <div class="timeline-event" id="event-prime" style="left: 31%;">
        <div class="event-box">
          <div class="event-label">Prime</div>
          <div class="event-content">A</div>
        </div>
        <div class="event-connector"></div>
        <div class="event-dot"></div>
        <div class="event-time">500 ms</div>
      </div>

      <!-- Target Event -->
      <div class="timeline-event" id="event-target" style="left: 47%;">
        <div class="event-box">
          <div class="event-label">Target</div>
          <div class="event-content">B</div>
        </div>
        <div class="event-connector"></div>
        <div class="event-dot"></div>
        <div class="event-time">750 ms</div>
      </div>

      <!-- Response Event -->
      <div class="timeline-event" id="event-response" style="left: 75%;">
        <div class="event-box">
          <div class="event-label">Response</div>
          <div class="event-content">?</div>
        </div>
        <div class="event-connector"></div>
        <div class="event-dot"></div>
        <div class="event-time">1200 ms</div>
      </div>
    </div>
  </div>

  <!-- Experiment Overlay -->
  <div id="experimentOverlay" class="experiment-overlay">
    <div class="experiment-container">

      <!-- Setup Screen -->
      <div id="experimentSetup" class="experiment-setup">
        <h2 id="experimentTitle">Experiment</h2>
        <p class="subtitle" id="experimentDescription">Configure and start the experiment</p>

        <div class="option-selectors" id="optionSelectors">
          <!-- Dynamic options will be inserted here -->
        </div>

        <button class="btn" onclick="startExperiment()">Start Experiment</button>
        <button class="btn btn-secondary" onclick="closeExperiment()" style="margin-left: 15px;">Cancel</button>
      </div>

      <!-- Trial Screen -->
      <div id="experimentTrial" class="experiment-trial">
        <div class="experiment-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
          </div>
          <div class="progress-text" id="progressText">Trial 1 of 20</div>
        </div>

        <div class="stimulus-display" id="stimulusDisplay">
          +
        </div>

        <p class="trial-instruction" id="trialInstruction">
          Press the key corresponding to the ink color
        </p>

        <div class="response-keys" id="responseKeys">
          <!-- Dynamic keys will be inserted here -->
        </div>
      </div>

      <!-- Results Screen -->
      <div id="experimentResults" class="experiment-results">
        <h2>Experiment Complete</h2>

        <div class="results-grid" id="resultsGrid">
          <!-- Dynamic results will be inserted here -->
        </div>

        <div class="experiment-buttons">
          <button class="btn" onclick="restartExperiment()">Try Again</button>
          <button class="btn btn-secondary" onclick="closeExperiment()">Close</button>
        </div>

        <div class="export-section">
          <h4>Export Your Results</h4>
          <div class="export-options">
            <div class="export-option">
              <button class="btn-export" onclick="exportResults('csv')">Download CSV</button>
              <p class="export-desc">Comma-separated values file</p>
            </div>
            <div class="export-option">
              <button class="btn-export" onclick="exportResults('xlsx')">Download Excel</button>
              <p class="export-desc">Microsoft Excel format</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Template Builder Overlay -->
  <div id="templateBuilderOverlay" class="template-builder-overlay">
    <div class="template-builder">
      <div class="builder-header">
        <h1>Template Builder</h1>
        <button class="builder-close" onclick="closeTemplateBuilder()">&times;</button>
      </div>

      <!-- Experiment Type Selection -->
      <div class="abcd-section">
        <h2>Experiment Configuration</h2>

        <label for="builderExperimentType">Experiment Type</label>
        <select id="builderExperimentType" onchange="updateBuilderPreview()">
          <option value="stroop">Stroop Task (Simultaneous)</option>
          <option value="semantic">Semantic Priming (Sequential)</option>
          <option value="affective">Affective Priming (Sequential)</option>
        </select>

        <!-- Stimulus Preview -->
        <div class="stimulus-combined">
          <h3>Stimulus Preview</h3>
          <div class="stimulus-preview" id="builderPreview" style="color: #ff0000;">
            BLUE
          </div>
          <div class="stimulus-breakdown">
            <div class="stimulus-part prime">
              <div class="stimulus-part-label">A - Prime</div>
              <div class="stimulus-part-value" id="builderPrimeValue">Word: "BLUE"</div>
            </div>
            <div class="stimulus-part target">
              <div class="stimulus-part-label">B - Target</div>
              <div class="stimulus-part-value" id="builderTargetValue">Color: Red</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Experimenter Identity -->
      <div class="abcd-section">
        <h2>Experimenter Identity</h2>

        <div class="identity-section">
          <label for="experimenterEmail">Your Email</label>
          <input type="email" id="experimenterEmail" placeholder="researcher@university.edu">

          <label for="userExperimentId">Experiment ID</label>
          <input type="text" id="userExperimentId" placeholder="e.g., study1_group_a">
          <p style="color: #9aa6b2; font-size: 0.85rem;">
            Use a unique ID to identify this experiment. You'll need this to retrieve your data later.
          </p>
        </div>
      </div>

      <!-- Generate Link Section -->
      <div class="abcd-section">
        <h2>Generate Participant Link</h2>

        <div class="checkbox-group">
          <input type="checkbox" id="requireExternalId">
          <label for="requireExternalId">Require External ID (Prolific, MTurk, SONA)</label>
        </div>

        <button class="btn" onclick="generateParticipantLink()" style="margin-top: 20px;">
          Generate Shareable Link
        </button>

        <div id="generatedLinkContainer" style="display: none; margin-top: 20px;">
          <label>Participant Link:</label>
          <input type="text" id="generatedLink" readonly style="font-size: 0.85rem;">
          <button class="btn btn-secondary" onclick="copyLink()" style="margin-top: 10px;">
            Copy Link
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Get Data Overlay -->
  <div id="getDataOverlay" class="template-builder-overlay">
    <div class="template-builder">
      <div class="builder-header">
        <h1>Get My Data</h1>
        <button class="builder-close" onclick="closeGetData()">&times;</button>
      </div>

      <div class="abcd-section">
        <h2>Retrieve Your Data</h2>

        <label for="dataEmail">Your Email</label>
        <input type="email" id="dataEmail" placeholder="researcher@university.edu">

        <label for="dataExperimentId">Experiment ID</label>
        <input type="text" id="dataExperimentId" placeholder="e.g., study1_group_a">

        <button class="btn" onclick="fetchMyData()" style="margin-top: 20px;">
          Retrieve Data
        </button>

        <div id="dataResultsContainer" style="display: none; margin-top: 30px;">
          <div class="success-message" id="dataResultsMessage"></div>

          <div class="export-options" style="margin-top: 20px;">
            <div class="export-option">
              <button class="btn-export" onclick="downloadData('csv')">Download CSV</button>
            </div>
            <div class="export-option">
              <button class="btn-export" onclick="downloadData('xlsx')">Download Excel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stroop Language Dominance Overlay -->
  <div class="stroop-overlay" id="stroop-overlay" tabindex="-1">
    <div class="stroop-container">
      <!-- Setup Screen -->
      <div class="stroop-setup" id="stroop-setup" style="max-height: 90vh; overflow-y: auto;">
        <h2>Stroop Language Dominance Test</h2>
        <p class="subtitle">Experience being a participant - discover which language you process faster</p>

        <div class="language-selectors">
          <div class="language-select-group">
            <label>Language 1 (Native/Primary)</label>
            <select id="language1">
              <option value="en">English</option>
              <option value="he">Hebrew</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="ru">Russian</option>
              <option value="ar">Arabic</option>
              <option value="zh">Chinese</option>
            </select>
          </div>
          <div class="language-select-group">
            <label>Language 2 (Secondary)</label>
            <select id="language2">
              <option value="he">Hebrew</option>
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="ru">Russian</option>
              <option value="ar">Arabic</option>
              <option value="zh">Chinese</option>
            </select>
          </div>
        </div>

        <!-- Clear Instructions Box -->
        <div style="background: rgba(102, 126, 234, 0.15); border: 2px solid rgba(102, 126, 234, 0.4); border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: left;">
          <h3 style="color: #ff4db8; margin-bottom: 15px; font-size: 1.1rem;">Instructions / How to Play:</h3>

          <p style="color: #e5e7eb; margin-bottom: 20px; font-size: 1rem; line-height: 1.6;">
            You will see <strong>color words</strong> written in <strong>colored ink</strong>.<br>
            Your task: Identify the <strong style="color: #ff4db8;">INK COLOR</strong> (the color you SEE), <strong>NOT</strong> the word meaning.
          </p>

          <!-- Visual Example -->
          <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <p style="color: #9aa6b2; margin-bottom: 15px; font-size: 0.9rem;">Example:</p>
            <div style="display: flex; align-items: center; gap: 30px; flex-wrap: wrap; justify-content: center;">
              <div style="text-align: center;">
                <span style="font-size: 2rem; font-weight: bold; color: #4444ff;">RED</span>
                <p style="color: #9aa6b2; font-size: 0.85rem; margin-top: 8px;">The word says "RED"<br>but the ink is <strong style="color: #4444ff;">BLUE</strong></p>
                <p style="color: #44ff44; font-size: 0.9rem; margin-top: 5px;">Press <strong>B</strong> for Blue</p>
              </div>
              <div style="text-align: center;">
                <span style="font-size: 2rem; font-weight: bold; color: #ff4444;">GREEN</span>
                <p style="color: #9aa6b2; font-size: 0.85rem; margin-top: 8px;">The word says "GREEN"<br>but the ink is <strong style="color: #ff4444;">RED</strong></p>
                <p style="color: #44ff44; font-size: 0.9rem; margin-top: 5px;">Press <strong>R</strong> for Red</p>
              </div>
            </div>
          </div>

          <p style="color: #ffff44; font-size: 0.95rem; margin-bottom: 0;">
            Respond as FAST and ACCURATELY as possible!
          </p>
        </div>

        <!-- Hebrew Instructions -->
        <details style="background: rgba(255, 77, 184, 0.1); border: 1px solid rgba(255, 77, 184, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 25px; cursor: pointer;">
          <summary style="color: #ff4db8; font-size: 0.95rem;">Click for Hebrew Instructions / הוראות בעברית</summary>
          <div style="margin-top: 15px; text-align: right; direction: rtl;">
            <p style="color: #e5e7eb; line-height: 1.8; font-size: 0.95rem;">
              <strong>הוראות:</strong><br>
              יוצגו בפניך מילים שמתארות צבעים, כתובות בדיו צבעוני.<br>
              המשימה שלך: לזהות את <strong style="color: #ff4db8;">צבע הדיו</strong> (הצבע שאת/ה רואה), <strong>ולא</strong> את משמעות המילה.<br><br>
              <strong>דוגמה:</strong> אם המילה "אדום" כתובה בדיו <span style="color: #4444ff;">כחול</span> - לחצ/י על <strong>B</strong> (כחול).<br><br>
              <span style="color: #ffff44;">הגיב/י מהר ומדויק ככל האפשר!</span>
            </p>
          </div>
        </details>

        <button class="btn" onclick="Stroop.start()">Start Experiment</button>
        <button class="btn btn-secondary" style="margin-left: 15px;" onclick="Stroop.close()">Cancel</button>
      </div>

      <!-- Trial Screen -->
      <div class="stroop-trial" id="stroop-trial">
        <!-- Exit button for mid-experiment exit -->
        <button onclick="Stroop.close()" style="position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #9aa6b2; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Exit</button>
        <div class="stroop-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-text">Trial <span id="current-trial">1</span> of <span id="total-trials">48</span></div>
        </div>
        <div class="stroop-stimulus" id="stroop-stimulus">
          <span class="stroop-fixation">+</span>
        </div>
        <p class="stroop-instruction">Press the key for the INK COLOR</p>
        <div class="stroop-keys" id="stroop-keys-container"></div>
      </div>

      <!-- Results Screen -->
      <div class="stroop-results" id="stroop-results">
        <h2>Your Results</h2>

        <div class="dominance-result">
          <h3>Language Dominance</h3>
          <div class="dominance-language" id="dominant-language">-</div>
          <p class="dominance-explanation" id="dominance-explanation"></p>
        </div>

        <div class="results-grid">
          <div class="result-card">
            <h3 id="lang1-name">Language 1</h3>
            <div class="result-value" id="lang1-rt">-</div>
            <div class="result-unit">ms avg RT</div>
          </div>
          <div class="result-card">
            <h3 id="lang2-name">Language 2</h3>
            <div class="result-value" id="lang2-rt">-</div>
            <div class="result-unit">ms avg RT</div>
          </div>
          <div class="result-card">
            <h3>Stroop Effect (L1)</h3>
            <div class="result-value" id="stroop-effect1">-</div>
            <div class="result-unit">ms (incongruent - congruent)</div>
          </div>
          <div class="result-card">
            <h3>Stroop Effect (L2)</h3>
            <div class="result-value" id="stroop-effect2">-</div>
            <div class="result-unit">ms (incongruent - congruent)</div>
          </div>
        </div>

        <div class="stroop-buttons">
          <button class="btn" onclick="Stroop.start()">Try Again</button>
          <button class="btn btn-secondary" onclick="Stroop.close()">Close</button>
        </div>

        <div class="export-section">
          <h4>Export Results</h4>
          <div class="export-options">
            <div class="export-option">
              <button class="btn btn-export" onclick="Stroop.exportCSV()">Download CSV</button>
              <p class="export-desc">Universal format for data analysis software (Python, R, MATLAB, SPSS)</p>
            </div>
            <div class="export-option">
              <button class="btn btn-export" onclick="Stroop.exportXLSX()">Download Excel</button>
              <p class="export-desc">Opens directly in Excel with formatted sheets - no dialogs or questions</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stroop Template Builder Overlay (V30 Structure) -->
  <div class="template-builder-overlay" id="stroop-builder-overlay">
    <div class="template-builder">
      <div class="builder-header">
        <h1>Stroop Experiment - Template Builder</h1>
        <button class="builder-close" onclick="Stroop.closeBuilder()">&times;</button>
      </div>

      <!-- Step 1: Experimenter Identification (Collapsible) -->
      <div class="collapsible-section expanded" id="section-identity" onclick="toggleSection('section-identity', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">1</span>
          <div>
            <div class="collapsible-title">Your Experiment Identity</div>
            <div class="collapsible-subtitle">Email and Experiment ID for data access</div>
          </div>
          <span class="collapsible-status"></span>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner">
            <p style="color: #c0c0c0; margin-bottom: 20px; font-size: 14px;">
              These two fields identify YOUR specific experiment. You'll need both to download your data later.
            </p>

            <!-- Email -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: 500;">Your Email</label>
              <input type="email" id="stroopExperimenterEmail" placeholder="your.email@university.edu"
                     style="width: 100%; padding: 15px; border-radius: 10px; border: 2px solid rgba(255, 77, 184, 0.4);
                            background: rgba(0,0,0,0.3); color: white; font-size: 16px;"
                     oninput="this.style.borderColor = this.validity.valid && this.value ? 'rgba(74, 222, 128, 0.7)' : 'rgba(255, 77, 184, 0.4)'"
                     onclick="event.stopPropagation()">
            </div>

            <!-- Experiment ID -->
            <div>
              <label style="display: block; color: #e0e0e0; margin-bottom: 8px; font-weight: 500;">Experiment ID <span style="color: #9aa6b2; font-weight: normal;">(a unique name for this experiment)</span></label>
              <div style="display: flex; gap: 10px;">
                <input type="text" id="stroopExperimentId" placeholder="e.g., stroop_study_dec2025"
                       style="flex: 1; padding: 15px; border-radius: 10px; border: 2px solid rgba(255, 77, 184, 0.4);
                              background: rgba(0,0,0,0.3); color: white; font-size: 16px;"
                       oninput="this.style.borderColor = this.value.length >= 3 ? 'rgba(74, 222, 128, 0.7)' : 'rgba(255, 77, 184, 0.4)'"
                       onclick="event.stopPropagation()">
                <button onclick="event.stopPropagation(); Stroop.generateExperimentId()" style="padding: 15px 20px; border-radius: 10px; border: none; background: rgba(102, 126, 234, 0.5); color: white; cursor: pointer; font-size: 14px; white-space: nowrap;">Generate ID</button>
              </div>
              <p style="margin-top: 8px; font-size: 12px; color: #9aa6b2;">
                Use a descriptive name you'll remember. If you run multiple experiments, each should have a unique ID.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: ABCD Framework (Collapsible) -->
      <div class="collapsible-section" id="section-abcd" onclick="toggleSection('section-abcd', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">2</span>
          <div>
            <div class="collapsible-title">ABCD Framework Structure</div>
            <div class="collapsible-subtitle">Prime (A) + Target (B) = Simultaneous presentation</div>
          </div>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner">
            <!-- Simultaneous Stimulus Display -->
            <div class="stimulus-combined" style="margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px;">Stimulus (A + B Combined)</h3>
              <div class="stimulus-preview stimulus-preview-live" id="stimulus-preview">
                <span id="preview-word" style="color: #4444ff;">RED</span>
              </div>
              <p style="color: #9aa6b2; font-size: 0.9rem; margin-top: 10px;">
                In Stroop, the prime and target appear <strong style="color: #ff4db8;">simultaneously</strong> in the same stimulus
              </p>

              <div class="stimulus-breakdown">
                <div class="stimulus-part prime">
                  <div class="stimulus-part-label">A (Prime)</div>
                  <div class="stimulus-part-name">Word Meaning</div>
                  <div class="stimulus-part-desc">The semantic content of the word - what it "says"</div>
                </div>
                <div class="stimulus-part target">
                  <div class="stimulus-part-label">B (Target)</div>
                  <div class="stimulus-part-name">Ink Color</div>
                  <div class="stimulus-part-desc">The visual color - what the participant must report</div>
                </div>
              </div>
            </div>

            <!-- Outcomes -->
            <div class="outcomes-row" style="margin-bottom: 20px;">
              <div class="outcome-box baseline">
                <div class="outcome-letter">C</div>
                <div class="outcome-name">Baseline Outcome</div>
                <div class="outcome-condition">When A = B (congruent)</div>
                <div class="outcome-example" id="example-congruent">"RED" in red ink</div>
              </div>

              <div class="effect-formula">
                <strong>Priming Effect</strong><br>
                D - C
              </div>

              <div class="outcome-box measured">
                <div class="outcome-letter">D</div>
                <div class="outcome-name">Measured Outcome</div>
                <div class="outcome-condition">When A != B (incongruent)</div>
                <div class="outcome-example" id="example-incongruent">"RED" in blue ink</div>
              </div>
            </div>

            <!-- Three Criteria -->
            <div class="criteria-section">
              <div class="criteria-title">Three Priming Criteria (All Met)</div>
              <div class="criteria-list">
                <div class="criterion">
                  <div class="criterion-check">&#10003;</div>
                  <div class="criterion-name">Association</div>
                  <div class="criterion-desc">Word meaning and ink color are associated through the color concept</div>
                </div>
                <div class="criterion">
                  <div class="criterion-check">&#10003;</div>
                  <div class="criterion-name">Secondariness</div>
                  <div class="criterion-desc">Word meaning is irrelevant to the task (report ink color only)</div>
                </div>
                <div class="criterion">
                  <div class="criterion-check">&#10003;</div>
                  <div class="criterion-name">Modulation</div>
                  <div class="criterion-desc">Word meaning affects RT despite being task-irrelevant (D != C)</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Define Stimuli (Collapsible) -->
      <div class="collapsible-section" id="section-stimuli" onclick="toggleSection('section-stimuli', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">3</span>
          <div>
            <div class="collapsible-title">Define Your Stimuli</div>
            <div class="collapsible-subtitle">Colors, words, and response keys</div>
          </div>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner">
            <!-- Editable Stimulus Table -->
            <div class="stimulus-editor">
              <div class="stimulus-editor-header" onclick="event.stopPropagation()">
                <span class="stimulus-editor-title">Define Your Stimuli (Colors & Words)</span>
                <button class="btn-add-stimulus" onclick="event.stopPropagation(); Stroop.addStimulusRow()">+ Add Color</button>
              </div>

              <table class="stimulus-table" id="stimulus-table" onclick="event.stopPropagation()">
                <thead>
                  <tr>
                    <th>Color</th>
                    <th>Ink (Hex)</th>
                    <th>Word (Lang 1)</th>
                    <th>Word (Lang 2)</th>
                    <th>Response Key</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="stimulus-table-body">
                  <!-- Rows generated by JavaScript -->
                </tbody>
              </table>

              <p class="stimulus-note">
                Each row defines a color concept. The system will create congruent trials (word matches ink) and incongruent trials (word differs from ink) automatically.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Try It Yourself (Collapsible) -->
      <div class="collapsible-section" id="section-preview" onclick="toggleSection('section-preview', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">4</span>
          <div>
            <div class="collapsible-title">Try It Yourself</div>
            <div class="collapsible-subtitle">Preview the experiment as a participant</div>
          </div>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner">
            <div class="try-it-cta" onclick="event.stopPropagation()">
              <div class="try-it-content">
                <div class="try-it-title">
                  TRY IT YOURSELF
                  <span class="try-it-arrow">--></span>
                </div>
                <div class="try-it-desc">
                  Experience the experiment from a participant's perspective. See how your stimuli will look and feel in action.
                </div>
              </div>
              <button class="btn-try-it" onclick="event.stopPropagation(); Stroop.previewFromBuilder()">START PREVIEW</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Parameters (Collapsible) -->
      <div class="collapsible-section" id="section-params" onclick="toggleSection('section-params', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">5</span>
          <div>
            <div class="collapsible-title">Experiment Parameters</div>
            <div class="collapsible-subtitle">Languages, trials, timing, and feedback</div>
          </div>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner" onclick="event.stopPropagation()">
            <div class="params-grid">
              <div class="param-group">
                <label for="builder-lang1">Language 1 (Primary)</label>
                <select id="builder-lang1">
                  <option value="en">English</option>
                  <option value="he">Hebrew</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="ru">Russian</option>
                  <option value="ar">Arabic</option>
                  <option value="zh">Chinese</option>
                </select>
                <div class="param-hint">The first language to test</div>
              </div>

              <div class="param-group">
                <label for="builder-lang2">Language 2 (Secondary)</label>
                <select id="builder-lang2">
                  <option value="he">Hebrew</option>
                  <option value="en">English</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="ru">Russian</option>
                  <option value="ar">Arabic</option>
                  <option value="zh">Chinese</option>
                </select>
                <div class="param-hint">The second language to compare</div>
              </div>

              <div class="param-group">
                <label for="builder-trials">Trials per Condition</label>
                <select id="builder-trials">
                  <option value="3">3 (Quick test - 48 total)</option>
                  <option value="5">5 (Standard - 80 total)</option>
                  <option value="10">10 (Extended - 160 total)</option>
                </select>
                <div class="param-hint">More trials = more reliable results, but longer duration</div>
              </div>

              <div class="param-group">
                <label for="builder-fixation">Fixation Duration (ms)</label>
                <input type="number" id="builder-fixation" value="500" min="200" max="2000" step="100">
                <div class="param-hint">How long the + symbol appears before each trial</div>
              </div>

              <div class="param-group">
                <label for="builder-feedback">Show Feedback</label>
                <select id="builder-feedback">
                  <option value="yes">Yes - show correct/incorrect</option>
                  <option value="no">No - proceed immediately</option>
                </select>
                <div class="param-hint">Whether to show participants if their response was correct</div>
              </div>

              <div class="param-group">
                <label for="builder-title">Experiment Title</label>
                <input type="text" id="builder-title" value="Stroop Language Dominance Test" placeholder="Enter a title...">
                <div class="param-hint">This title will be shown to participants</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 6: Data Collection (Collapsible) -->
      <div class="collapsible-section" id="section-data" onclick="toggleSection('section-data', event)">
        <div class="collapsible-header">
          <span class="collapsible-step">6</span>
          <div>
            <div class="collapsible-title">Data Collection</div>
            <div class="collapsible-subtitle">Cloud storage and connection status</div>
          </div>
          <span class="collapsible-arrow">▼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-inner" onclick="event.stopPropagation()">
            <p class="data-description">
              Participant results are automatically saved to a secure cloud database.
              No setup required - data collection works out of the box.
            </p>

            <div class="connection-status" id="connection-status">
              <div class="status-dot"></div>
              <div class="status-text">
                <strong>Connected</strong> - Data will be saved automatically
              </div>
            </div>

            <button class="btn-test-connection" onclick="event.stopPropagation(); Stroop.testConnection()">Test Connection</button>

            <details class="data-info">
              <summary>How data collection works</summary>
              <div class="data-info-content">
                <p>When participants complete the experiment, their results are automatically saved to a secure database:</p>
                <ul style="margin-top: 10px; padding-left: 20px;">
                  <li>Each trial is saved with: <code>experiment_id</code>, <code>participant_id</code>, <code>trial_number</code>, <code>language</code>, <code>ink_color</code>, <code>word_meaning</code>, <code>congruent</code>, <code>response</code>, <code>correct</code>, <code>rt</code></li>
                  <li>Participant IDs are randomly generated</li>
                  <li>No personal information is collected</li>
                  <li>Data can be exported to CSV or Excel from the Supabase dashboard</li>
                </ul>
              </div>
            </details>
          </div>
        </div>
      </div>

      <!-- Action Buttons (Always visible at bottom) -->
      <div class="builder-actions" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(255, 77, 184, 0.1), rgba(102, 126, 234, 0.1)); border-radius: 16px; border: 1px solid rgba(255, 77, 184, 0.3);">
        <button class="btn-preview" onclick="Stroop.previewFromBuilder()">Preview Experiment</button>
        <button class="btn-generate" onclick="Stroop.generateLink()">Generate Shareable Link</button>
      </div>

    </div>
  </div>

  <!-- JavaScript Modules -->
  <script src="js/core.js"></script>
  <script src="js/engine.js"></script>
  <script src="js/stroop.js"></script>

  <!-- Main Application Script -->
  <script>
    // Toggle collapsible sections
    function toggleSection(sectionId, event) {
      // Don't toggle if clicking on interactive elements inside
      if (event && event.target.closest('input, button, select, textarea, table, .btn-add-stimulus')) {
        return;
      }

      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('expanded');
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      PTA.initSupabase();
    });

    // Current experiment config
    let currentConfig = null;
    let retrievedData = null;

    // Load experiment configuration
    function loadExperimentConfig(type) {
      // Predefined experiment configurations
      const configs = {
        stroop: {
          id: 'stroop-language',
          name: 'Stroop Task',
          description: 'Identify the ink color, ignore the word meaning',
          type: 'stroop',
          colors: {
            red: { hex: '#ff4444', word: 'RED' },
            green: { hex: '#44ff44', word: 'GREEN' },
            blue: { hex: '#4444ff', word: 'BLUE' },
            yellow: { hex: '#ffff44', word: 'YELLOW' }
          },
          presentation: {
            mode: 'simultaneous',
            fixation_ms: 500,
            ITI_ms: 500
          },
          response: {
            type: 'key_press',
            keys: { 'red': 'R', 'green': 'G', 'blue': 'B', 'yellow': 'Y' }
          },
          trials: {
            randomize: true,
            congruent_reps: 2,
            incongruent_reps: 2
          },
          feedback: {
            show: true,
            duration_ms: 300,
            correct_text: 'Correct!',
            incorrect_text: 'Incorrect'
          },
          data: {
            save_to_supabase: true,
            table_name: 'experiment_results'
          }
        },
        semantic: {
          id: 'semantic-priming',
          name: 'Semantic Priming',
          description: 'Lexical decision task with related/unrelated primes',
          primes: {
            type: 'text',
            items: ['DOCTOR', 'BREAD', 'TABLE', 'BIRD']
          },
          targets: {
            type: 'text',
            items: ['NURSE', 'BUTTER', 'CHAIR', 'WING']
          },
          presentation: {
            mode: 'sequential',
            fixation_ms: 500,
            prime_duration_ms: 200,
            ISI_ms: 50,
            ITI_ms: 1500
          },
          response: {
            type: 'key_press',
            keys: { 'word': 'J', 'nonword': 'F' }
          },
          trials: {
            randomize: true,
            repetitions: 2
          },
          data: {
            save_to_supabase: true,
            table_name: 'experiment_results'
          }
        },
        affective: {
          id: 'affective-priming',
          name: 'Affective Priming',
          description: 'Evaluate target valence after emotional primes',
          primes: {
            type: 'text',
            items: ['HAPPY', 'LOVE', 'SAD', 'HATE']
          },
          targets: {
            type: 'text',
            items: ['JOY', 'PEACE', 'FEAR', 'ANGER']
          },
          presentation: {
            mode: 'sequential',
            fixation_ms: 500,
            prime_duration_ms: 150,
            ISI_ms: 100,
            ITI_ms: 1500
          },
          response: {
            type: 'key_press',
            keys: { 'positive': 'P', 'negative': 'N' }
          },
          trials: {
            randomize: true,
            repetitions: 2
          },
          data: {
            save_to_supabase: true,
            table_name: 'experiment_results'
          }
        }
      };

      currentConfig = configs[type] || null;
    }

    // Show Try Experiment
    function showTryExperiment() {
      const type = document.getElementById('experimentSelect').value;

      // Default to Stroop if nothing selected, or use Stroop module for Stroop experiment
      if (type === 'stroop' || !type) {
        Stroop.open();
        return;
      }

      loadExperimentConfig(type);
      if (!currentConfig) {
        alert('Configuration not found.');
        return;
      }

      // Set up the experiment UI
      document.getElementById('experimentTitle').textContent = currentConfig.name;
      document.getElementById('experimentDescription').textContent = currentConfig.description;

      // Set up response keys display
      const keysContainer = document.getElementById('responseKeys');
      keysContainer.innerHTML = '';
      for (const [label, key] of Object.entries(currentConfig.response.keys)) {
        keysContainer.innerHTML += `
          <div class="key-hint">
            <span class="key">${key}</span>
            <span class="label">${label}</span>
          </div>
        `;
      }

      // Show overlay
      document.getElementById('experimentOverlay').classList.add('active');
      document.getElementById('experimentSetup').style.display = 'block';
      document.getElementById('experimentTrial').classList.remove('active');
      document.getElementById('experimentResults').classList.remove('active');
    }

    // Start experiment
    function startExperiment() {
      if (!currentConfig) {
        alert('No experiment configured.');
        return;
      }

      // Initialize engine
      PTA.Engine.init(currentConfig)
        .bindElements({
          stimulusDisplay: 'stimulusDisplay',
          progressBar: 'progressFill',
          progressText: 'progressText',
          setupScreen: 'experimentSetup',
          trialScreen: 'experimentTrial',
          resultsScreen: 'experimentResults'
        })
        .generateTrials()
        .start();
    }

    // Close experiment
    function closeExperiment() {
      PTA.Engine.reset();
      document.getElementById('experimentOverlay').classList.remove('active');
    }

    // Restart experiment
    function restartExperiment() {
      document.getElementById('experimentResults').classList.remove('active');
      document.getElementById('experimentSetup').style.display = 'block';
    }

    // Export results
    function exportResults(format) {
      const results = PTA.Engine.getResults();
      const filename = `${currentConfig.id}_results_${Date.now()}`;

      if (format === 'csv') {
        PTA.exportToCSV(results, filename + '.csv');
      } else if (format === 'xlsx') {
        PTA.exportToExcel(results, filename + '.xlsx');
      }
    }

    // Listen for experiment complete
    document.addEventListener('experimentComplete', function(e) {
      const { results, stats } = e.detail;

      // Display results based on experiment type
      const grid = document.getElementById('resultsGrid');

      if (stats.stroopEffect !== undefined) {
        // Stroop-specific results
        grid.innerHTML = `
          <div class="result-card">
            <h3>Mean RT</h3>
            <div class="result-value">${Math.round(stats.meanRT)}</div>
            <div class="result-unit">milliseconds</div>
          </div>
          <div class="result-card">
            <h3>Error Rate</h3>
            <div class="result-value">${stats.errorRate.toFixed(1)}%</div>
            <div class="result-unit">${results.filter(r => !r.correct).length}/${stats.totalTrials} errors</div>
          </div>
          <div class="result-card">
            <h3>Congruent RT</h3>
            <div class="result-value">${Math.round(stats.congruentRT)}</div>
            <div class="result-unit">milliseconds</div>
          </div>
          <div class="result-card">
            <h3>Incongruent RT</h3>
            <div class="result-value">${Math.round(stats.incongruentRT)}</div>
            <div class="result-unit">milliseconds</div>
          </div>
          <div class="result-card" style="grid-column: span 2; background: rgba(255, 77, 184, 0.1); border-color: rgba(255, 77, 184, 0.5);">
            <h3 style="color: #ff4db8;">Stroop Effect</h3>
            <div class="result-value" style="color: #ff4db8;">${Math.round(stats.stroopEffect)}</div>
            <div class="result-unit">ms (Incongruent - Congruent)</div>
          </div>
        `;
      } else {
        // Generic results
        grid.innerHTML = `
          <div class="result-card">
            <h3>Mean RT</h3>
            <div class="result-value">${Math.round(stats.meanRT)}</div>
            <div class="result-unit">milliseconds</div>
          </div>
          <div class="result-card">
            <h3>Error Rate</h3>
            <div class="result-value">${stats.errorRate.toFixed(1)}%</div>
            <div class="result-unit">${results.filter(r => !r.correct).length}/${stats.totalTrials} errors</div>
          </div>
        `;
      }
    });

    // Template Builder functions
    function showTemplateBuilder() {
      const type = document.getElementById('experimentSelect').value;

      // Use Stroop Builder for Stroop experiment (or default to Stroop if nothing selected)
      if (type === 'stroop' || !type) {
        Stroop.openBuilder();
        return;
      }

      document.getElementById('templateBuilderOverlay').classList.add('active');
    }

    function closeTemplateBuilder() {
      document.getElementById('templateBuilderOverlay').classList.remove('active');
    }

    function updateBuilderPreview() {
      // Update preview based on selected experiment type
      const type = document.getElementById('builderExperimentType').value;
      const preview = document.getElementById('builderPreview');
      const primeValue = document.getElementById('builderPrimeValue');
      const targetValue = document.getElementById('builderTargetValue');

      if (type === 'stroop') {
        preview.textContent = 'BLUE';
        preview.style.color = '#ff0000';
        primeValue.textContent = 'Word: "BLUE"';
        targetValue.textContent = 'Color: Red';
      } else if (type === 'semantic') {
        preview.textContent = 'NURSE';
        preview.style.color = '#ffffff';
        primeValue.textContent = 'Prime: "DOCTOR"';
        targetValue.textContent = 'Target: "NURSE"';
      } else if (type === 'affective') {
        preview.textContent = 'JOY';
        preview.style.color = '#ffffff';
        primeValue.textContent = 'Prime: "HAPPY"';
        targetValue.textContent = 'Target: "JOY"';
      }
    }

    function generateParticipantLink() {
      const email = document.getElementById('experimenterEmail').value;
      const expId = document.getElementById('userExperimentId').value;
      const expType = document.getElementById('builderExperimentType').value;
      const requireExtId = document.getElementById('requireExternalId').checked;

      if (!email || !expId) {
        alert('Please enter your email and experiment ID.');
        return;
      }

      loadExperimentConfig(expType);
      if (!currentConfig) {
        alert('Please select an experiment type.');
        return;
      }

      // Add experimenter info to config
      currentConfig.experimenter = {
        email: email,
        experiment_id: expId
      };
      currentConfig.requireExternalId = requireExtId;

      // Encode config
      const encoded = PTA.encodeConfig(currentConfig);
      const baseUrl = window.location.origin + window.location.pathname;
      const link = baseUrl + '?config=' + encoded;

      document.getElementById('generatedLink').value = link;
      document.getElementById('generatedLinkContainer').style.display = 'block';
    }

    function copyLink() {
      const linkInput = document.getElementById('generatedLink');
      linkInput.select();
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    }

    // Get Data functions
    function showGetData() {
      document.getElementById('getDataOverlay').classList.add('active');
    }

    function closeGetData() {
      document.getElementById('getDataOverlay').classList.remove('active');
    }

    async function fetchMyData() {
      const email = document.getElementById('dataEmail').value;
      const expId = document.getElementById('dataExperimentId').value;

      if (!email || !expId) {
        alert('Please enter your email and experiment ID.');
        return;
      }

      const { data, error } = await PTA.fetchExperimenterData('experiment_results', email, expId);

      if (error) {
        alert('Error fetching data: ' + error.message);
        return;
      }

      retrievedData = data;

      document.getElementById('dataResultsMessage').textContent =
        `Found ${data.length} trials from your experiment.`;
      document.getElementById('dataResultsContainer').style.display = 'block';
    }

    function downloadData(format) {
      if (!retrievedData || retrievedData.length === 0) {
        alert('No data to download.');
        return;
      }

      const email = document.getElementById('dataEmail').value;
      const expId = document.getElementById('dataExperimentId').value;
      const filename = `${expId}_${email.split('@')[0]}_${Date.now()}`;

      if (format === 'csv') {
        PTA.exportToCSV(retrievedData, filename + '.csv');
      } else if (format === 'xlsx') {
        PTA.exportToExcel(retrievedData, filename + '.xlsx');
      }
    }

    // Learn More function
    function showLearnMore() {
      alert('Documentation coming soon!\n\nThe ABCD Framework provides a unified definition of priming across disciplines.\n\nFor more information, see Sivroni & Stark (2025).');
    }

    // Check for config in URL (participant mode)
    function checkUrlConfig() {
      const params = PTA.getUrlParams();
      if (params.config) {
        const config = PTA.decodeConfig(params.config);
        if (config) {
          currentConfig = config;
          // Auto-start experiment for participants
          showTryExperiment();
        }
      }
    }

    // Run on load
    document.addEventListener('DOMContentLoaded', function() {
      PTA.initSupabase();

      // First check for Stroop URL config (participant links)
      if (!Stroop.checkUrlConfig()) {
        // If not a Stroop participant link, check for generic config
        checkUrlConfig();
      }
    });
  </script>

</body>
</html>
